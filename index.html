<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>mmm</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            overflow: hidden;   /* 전체 페이지 스크롤 숨기기 */
            }
        body {
          font-family: 'Inter', sans-serif;
        }

        button {all: unset; cursor: pointer; transition: all 0.2s ease;}
        .container{
            display: flex;
            margin: 0;
            font-size: 1.5rem;
        }
        .box-logo{
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #BF1122;
            outline: 2px solid #BF1122;
        }
        #logo {
            cursor: pointer;
        }
        
        .box-custom-options{
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #E6E6E6;
            outline: 2px solid #BF1122;
        }
        .option-head{
            display:inline-flex;
            width:100%;
            color:#FFFFFF;
        }
        .title{
            flex: 0 0 60%;
            padding-left: 8px; padding-top: 2px; padding-bottom: 2px;
            background-color: #BF1122;
            outline: 2px solid #BF1122;
        }
        .color-swatch{
            flex: 0 0 40%;
            outline: 2px solid #BF1122;
            cursor:pointer;
        }
        #color-palette{
            position:absolute; z-index:9999; padding:0px; background:#fff; outline:2px solid #BF1122;
            display:grid; grid-template-columns:repeat(5, 60px); gap:0px;
        }
        #color-palette[hidden]{ display:none; }
        #color-palette button{
            width:60px; height:50px; border:none; cursor:pointer;
        }
        
        .options{
            background-color: #E6E6E6; color: #BF1122;
            padding-left: 8px; padding-top: 6px; padding-bottom: 30px;
            display:flex; flex-direction:column;
            gap: 2px
        }
        .opt{display:block; cursor:pointer; user-select:none}
        .opt:hover{background:#dcdcdc}
        .opt.active{font-weight:600;}

        .box-preview{
            position: relative;
            width: 50%;
            height: 100vh;
            background-color: #f9f9f9;
            outline: 2px solid #BF1122;
        }

        .menu-back-forward {
            display: flex;
            width: 100%;
            color: #BF1122;
            border-bottom: 2px solid #BF1122;
            position: relative;
            z-index: 1000;
            }

        #btn-back,
            #btn-forward {
            flex: 1 1 0;  
            box-sizing: border-box;
            background-color: #ffffff;
            padding-left: 8px;
            padding-top: 2px;
            padding-bottom: 2px;
            font-size: inherit;
            line-height: 1.2;
            cursor: pointer;
            border: none;
            outline: none;
            color: #BF1122;
            }

        #btn-back:hover, #btn-forward:hover {
            background-color: #BF1122; color: #FFFFFF;
            }
        
        #btn-forward {
            border-left: 2px solid #BF1122; 
            }
            #btn-forward:hover {
            color: #FFFFFF; /* hover 시엔 또렷하게 */
            }

        .complete-bar{
            display: flex;
            width: 100%;
            position: absolute; bottom: 0; 
            padding-top: 6px; padding-bottom: 16px;
            background-color: #ffffff; color:#BF1122;
            outline: 2px solid #BF1122;
            justify-content: center;
            cursor: pointer;
        }
        .complete-bar:hover{background-color: #BF1122; color: #FFFFFF;}

        .box_archive{
            position: relative;
            width:20%;
            height: 100vh;
            background-color: #f9f9f9;
            outline: 2px solid #BF1122;
            display: flex;              /* 추가 */
            flex-direction: column;     /* 추가 */
        }

        .archive-head{
            padding-left: 8px; padding-top: 2px; padding-bottom: 2px;
            background-color: #BF1122; color:#FFFFFF;
            outline: 2px solid #BF1122;
            flex: 0 0 auto;             /* 추가 (헤더는 고정 높이) */
        }

        .archive-list{
            flex: 1 1 auto;             /* 남은 영역 전부 차지 */
            overflow-y: auto;           /* ← 스크롤 여기만! */
            padding: 12px;              /* 살짝 여백 주면 깔끔 */
        }

        .archive-list img{
            width:80%;
            display:block;
            margin:16px auto;
        }



        .popup {
            position: fixed;
            top: 0;
            right: 0;             /* 좌측 로고 영역만 남기고 */
            width: 85%;
            height: 100vh;
            display: none;         /* 기본 숨김 */
            z-index: 99999;
            background: url("./svg/popup-bg.svg") no-repeat center;
            background-size: 1620px auto; /* px 단위로 고정 크기 유지 */   
            align-items: center;
            justify-content: center;
            transform-origin: center;
            animation: popIn 420ms cubic-bezier(.2,1.3,.3,1) both;
        }

        .popup.show { display: flex; }

        .popup-complete-panel{
          position: relative;
          width: 60%;
          align-items: center;
          justify-content: center;
        }
        .complete-box{
          width: 98%;
          display: block;
          z-index: 1;
        }
        
        .popup-snapshot {
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 90%;
          height: auto;
          object-fit: contain;
          z-index: 2;
          pointer-events: none;
        }

        .popup-right-panel{
          width: 30%;
          height:100vh;
          padding-left: 40px;
        }

        .sticker{
          margin-top: 100px;
        }

        .minutes-window{
          outline: 2px solid #BF1122;
          background:#BF1122; 
          color:#fff;
          margin-top: 90px;
          margin-left: 10px;
          margin-right: 40px;
        }
        .minutes-title{ 
          font-weight:400; 
          font-size: 1.5rem;
          padding-left: 12px; padding-top: 5px; padding-bottom: 1px;
          outline: 2px solid #BF1122;
        }
        .minutes-value{
          background:#E6E6E6; color:#BF1122;
          margin-top:8px; 
          padding:10px 14px; font-weight:400; 
          font-size: 5rem; letter-spacing: .04em;
          outline: 2px solid #BF1122;
        }

        /* create new 버튼 */
        .btn-new{
            margin-top: 100px;
            display:flex; align-items:center; justify-content:center;
            font-size: 1.5rem;
            width:140px; height:140px; border-radius:999px;
            background:#E6E6E6; color:#BF1122; 
            border:2px solid #BF1122; font-weight:400;
            text-align: center; line-height: 120%;
        }
        .btn-new:hover{ background:#BF1122; color: #ffffff;}

        /* 닫기(X) */
        .close {
            position:absolute; top:14px; right:18px; 
            font-size:28px; cursor:pointer; color:hsl(354, 84%, 41%);
        }

        @keyframes popIn {
            0%   { transform: scale(.0);   opacity: 0; }
            70%  { transform: scale(1.06); opacity: 1; }
            100% { transform: scale(1);    opacity: 1; }
        }
                      

        .layer:not([src]) {
          display: none;
        }

        /* ▼ 추가: 회전 가능한 시침/분침/초침용 공통 스타일  */
        .hand-layer {
          position: absolute;
          left: 50%;
          top: 50%;
          width: 90%;
          height: 90%;
          object-fit: contain;
          transform-origin: 50% 50%;
        }


        .color-hint {
            position: fixed;
            z-index: 5000;
            pointer-events: none;

            /* 얘네는 JS에서 덮어쓸 거라 기본값 정도만 */
            top: 0;
            left: 0;

            animation: floaty 2.0s ease-in-out infinite;
            opacity: 1;
            transition: opacity 0.4s ease;
            }

            .color-hint.hidden {
            opacity: 0;
            pointer-events: none;
            }

            @keyframes floaty {
            0%   { transform: translateY(8px);   }
            50%  { transform: translateY(0px);  }
            100% { transform: translateY(8px);   }
            }

            .color-hint img {
            display: block;
            width: 220px; /* 너 svg/말풍선 크기에 맞춰서 조정해 */
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
            }


    </style>
</head>

<body>
  
<div class="container">
    <header class="box-logo">
        <img id="logo" src="./svg/logo.svg" style="width: 80%; padding: 16px">
    </header>

    <aside class="box-custom-options">
        <nav class="group" data-group="dial">
            <div class="option-head">
                <div class="title">dials</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="house">house</span>
                <span class="opt" data-value="convex square">convex square</span>
            </div>
        </nav>
        <nav class="group" data-group="numerals">
            <div class="option-head">
                <div class="title">numerals</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="numbers">numbers</span>
                <span class="opt" data-value="two dots">two dots</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
                <span class="opt" data-value="small sectors">small sectors</span>
                <span class="opt" data-value="big sectors">big sectors</span>
                <span class="opt" data-value="small squares">small squares</span>
                <span class="opt" data-value="big squares">big squares</span>
            </div>
        </nav>
        <nav class="group" data-group="marks">
            <div class="option-head">
                <div class="title">marks</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="line">line</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
            </div>
        </nav>
        <nav class="group" data-group="hands">
            <div class="option-head">
                <div class="title">hands</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="straight">straight</span>
                <span class="opt" data-value="arrow">arrow</span>
            </div>
        </nav>
    </aside>

    <main class="box-preview">
        <div class="menu-back-forward">
            <button id="btn-back" title="뒤로가기">↩︎ back</button>
            <button id="btn-forward" title="앞으로가기">↪︎ forward</button>
        </div>  
        <div class="stage-wrap">
            <div class="stage" id="stage">
                <!-- 시계 레이어 -->
                <img id="L-dial" class="layer" alt="dial layer" />
                <img id="L-numerals" class="layer" alt="numerals layer" />
                <img id="L-marks" class="layer" alt="marks layer" />

                <!-- hands를 세 장으로 쪼갠 버전 -->
                <img id="L-hour"   class="layer hand-layer" alt="hour hand layer" />
                <img id="L-minute" class="layer hand-layer" alt="minute hand layer" />
                <img id="L-second" class="layer hand-layer" alt="second hand layer" />
            </div>
        </div>
        <div class="complete-bar" id="btn-complete">
            <button class="complete-btn">complete!</button>
        </div>
    </main>

    <aside class="box_archive">
        <div class="archive-head" aria-hidden="true">&nbsp;archive preview</div>
        <div class="archive-list" id="archiveList"></div>
    </aside>

</div>

<div id="color-palette" hidden>
  <button data-color="#C41224"></button>
  <button data-color="#EF4B3E"></button>
  <button data-color="#7ED0FF"></button>
  <button data-color="#D8F2C9"></button>
  <button data-color="#E4B5F1"></button>
  <button data-color="#5A1E22"></button>
  <button data-color="#E2C7CF"></button>
  <button data-color="#F7F0A4"></button>
  <button data-color="#FFFFFF"></button>
  <button data-color="#EBEBEB"></button>
</div>


<div id="popup" class="popup">
    <div class="popup-complete-panel">
      <img src="./svg/complete _box.svg" class="complete-box">
      <img id="popupSnapshot" class="popup-snapshot" alt="">
    </div>

    <div class="popup-right-panel">
      <img src="./svg/sticker.svg" class="sticker">
      <div class="minutes-window">
        <div class="minutes-title">your minutes are…</div>
        <div id="minutesNow" class="minutes-value">00:00:00</div>
      </div>
      <button id="btn-create-new" class="btn-new">create<br>new!</button>
    </div>
</div>

<div id="color-hint" class="color-hint">
  <img src="./svg/color-hint.svg" alt="try changing the colors!">
</div>

</body>
</html>



<script>
/* ============ 상태/DOM ============ */
const groups = ['dial','numerals','marks','hands'];
const stageEl = document.getElementById('stage');
const archiveList = document.getElementById('archiveList');
const palette = document.getElementById('color-palette');

const imgEls = {
  dial:     document.getElementById('L-dial'),
  numerals: document.getElementById('L-numerals'),
  marks:    document.getElementById('L-marks'),

  // hands는 세 장
  hour:     document.getElementById('L-hour'),
  minute:   document.getElementById('L-minute'),
  second:   document.getElementById('L-second'),
};

const defaultColors = {
  dial: '#7ED0FF',
  numerals: '#F7F0A4',
  marks: '#D3F4C9',
  hands: '#5F272C'
};

let state = {
  dial:      { shape:null, color: defaultColors.dial },
  numerals:  { shape:null, color: defaultColors.numerals },
  marks:     { shape:null, color: defaultColors.marks },
  hands:     { shape:null, color: defaultColors.hands }
};

/* 힌트 풍선 관련 */
const hintEl = document.getElementById('color-hint');
let hintDismissed = false;

/* ============ 파일명 매핑(예외 보정) ============ */
/* 규칙: ./svg/{group}_{value}.svg */
const OVERRIDE = {
  numerals: {
    'numbers': 'numbers',
    'big squares': 'big squares'
  }
};

function filePath(group, value){
  const mapped = (OVERRIDE[group] && OVERRIDE[group][value]) ? OVERRIDE[group][value] : value;
  return `./svg/${group}_${mapped}.svg`;
}

/* ============ 히스토리(뒤/앞) ============ */
const history = [];
let histIndex = -1;

function pushHistory(){
  history.splice(histIndex+1);
  history.push(JSON.parse(JSON.stringify(state)));
  histIndex = history.length - 1;
  updateNavButtons();
}
function restoreFromHistory(i){
  if(i<0 || i>=history.length) return;
  state = JSON.parse(JSON.stringify(history[i]));
  histIndex = i;
  applyStateToUI();
  updateNavButtons();
}
function updateNavButtons(){
  const b = document.getElementById('btn-back');
  const f = document.getElementById('btn-forward');
  if (b) b.style.opacity = (histIndex>0)?1:0.4;
  if (f) f.style.opacity = (histIndex<history.length-1)?1:0.4;
}

/* ============ SVG 색 적용 ============ */
async function colorizeSVGToURL(url, color){
  try{
    const res = await fetch(url);
    const text = await res.text();
    const styled = text.replace(
      /<svg([^>]*)>/i,
      (m,attrs)=>`<svg${attrs}><style>*{fill:${color};stroke:${color};}</style>`
    );
    const blob = new Blob([styled], {type:'image/svg+xml'});
    return URL.createObjectURL(blob);
  }catch(e){
    console.warn('fetch/colorize 실패 → 원본 경로 사용:', url, e);
    return url;
  }
}

/* ============ 레이어 반영 (dial / numerals / marks) ============ */
async function applyLayer(group){
  const {shape, color} = state[group];
  const img = imgEls[group];
  if(!img) return; // safety
  if(!shape){ 
    img.removeAttribute('src'); 
    return; 
  }

  const src = filePath(group, shape);
  const coloredURL = await colorizeSVGToURL(src, color);
  img.src = coloredURL;

  // 기본 크기: 90% (가운데 배치)
  let size = 90;

  // dial이 'house'일 때 numerals만 살짝 더 작게
  if (group === 'numerals' && state.dial.shape === 'house') {
    size = 90 * 0.9; // 81
  }

  const offset = (100 - size) / 2;

  img.style.width = `${size}%`;
  img.style.height = `${size}%`;
  img.style.objectFit = 'contain';
  img.style.position = 'absolute';
  img.style.left = `${offset}%`;
  img.style.top = `${offset}%`;
}

/* ============ hands 전용 반영 (hour / minute / second) ============ */
async function applyHandsLayer() {
  const { shape, color } = state.hands;

  if (!shape) {
    // hands 선택 안 한 상태 → 다 지우기
    imgEls.hour.removeAttribute('src');
    imgEls.minute.removeAttribute('src');
    imgEls.second.removeAttribute('src');
    return;
  }

  // 파일명 규칙:
  // hands_{shape}_hour.svg
  // hands_{shape}_minute.svg
  // hands_second.svg (초침은 공통)
  const hourPath   = `./svg/hands_${shape}_hour.svg`;
  const minutePath = `./svg/hands_${shape}_minute.svg`;
  const secondPath = `./svg/hands_second.svg`;

  const hourURL   = await colorizeSVGToURL(hourPath,   color);
  const minuteURL = await colorizeSVGToURL(minutePath, color);
  const secondURL = await colorizeSVGToURL(secondPath, color);

  imgEls.hour.src   = hourURL;
  imgEls.minute.src = minuteURL;
  imgEls.second.src = secondURL;

  // 공통 배치 (시계 중앙에 맞추기)
  [imgEls.hour, imgEls.minute, imgEls.second].forEach(img => {
    img.style.width      = `90%`;
    img.style.height     = `90%`;
    img.style.objectFit  = 'contain';
    img.style.position   = 'absolute';
    img.style.left       = `5%`;  // (100-90)/2
    img.style.top        = `5%`;
    // transform-origin은 CSS .hand-layer에서 이미 50% 50%
    // 회전은 updateHandRotation()에서 계속 덮어씀
  });
}

/* ============ 바늘 회전 ============ */
/* 현재 시간을 읽어서 각 침의 회전각을 적용한다 */
function updateHandRotation() {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const s = now.getSeconds();

  // 각도 계산
  // 시침: 12시간 기준, 분/초 반영
  const hourDeg   = ((h % 12) + m/60 + s/3600) * 30;   // 360/12 = 30
  // 분침: 초 반영
  const minuteDeg = (m + s/60) * 6;                    // 360/60 = 6
  // 초침
  const secondDeg = s * 6;

  // 해당 각도를 transform에 넣는다
  if (imgEls.hour) {
    imgEls.hour.style.transform   = `rotate(${hourDeg}deg)`;
  }
  if (imgEls.minute) {
    imgEls.minute.style.transform = `rotate(${minuteDeg}deg)`;
  }
  if (imgEls.second) {
    imgEls.second.style.transform = `rotate(${secondDeg}deg)`;
  }
}

/* ============ 전체 state → 화면 반영 ============ */
function applyStateToUI(){
  // 좌측 메뉴 active 표시 / 스와치 색 반영
  document.querySelectorAll('.group').forEach(g=>{
    const group = g.dataset.group;
    const sel = state[group].shape;
    g.querySelectorAll('.opt').forEach(o=>{
      o.classList.toggle('active', o.dataset.value === sel);
    });
    const sw = g.querySelector('.color-swatch');
    if(sw) sw.style.backgroundColor = state[group].color;
  });

  // dial / numerals / marks
  ['dial','numerals','marks'].forEach(applyLayer);

  // hands
  applyHandsLayer();
  // 회전 갱신도 즉시 한 번 (새 디자인 선택 직후 바로 각도 맞춰 보이게)
  updateHandRotation();
}

/* ============ 옵션(도형) 클릭 ============ */
document.querySelectorAll('.group .opt').forEach(opt=>{
  opt.addEventListener('click', async (e)=>{
    const group = e.currentTarget.closest('.group').dataset.group;
    const value = e.currentTarget.dataset.value;
    state[group].shape = value;

    const wrap = e.currentTarget.parentElement;
    wrap.querySelectorAll('.opt').forEach(el=>el.classList.remove('active'));
    e.currentTarget.classList.add('active');

    if (group === 'hands') {
      await applyHandsLayer();
    } else {
      await applyLayer(group);
    }

    // 최신 상태 반영 + 히스토리
    updateHandRotation();
    pushHistory();
  });
});

/* ============ 팔레트(컬러 변경) ============ */
let currentSwatch = null;
let currentGroup = null;

/* numerals 스와치 오른쪽에 힌트를 붙이는 함수 */
function positionHintToNumerals() {
  if (!hintEl) return;
  if (hintDismissed) return;

  const numeralsSwatch = document.querySelector('.group[data-group="numerals"] .color-swatch');
  if (!numeralsSwatch) return;

  const rect = numeralsSwatch.getBoundingClientRect();
  const offsetX = 8;
  const offsetY = -10;

  hintEl.style.left = (rect.right + offsetX) + 'px';
  hintEl.style.top  = (rect.top   + offsetY) + 'px';
}

/* 스와치 클릭 → 팔레트 토글 / 힌트 사라짐 */
document.querySelectorAll('.group .color-swatch').forEach(swatch=>{
  swatch.addEventListener('click',(e)=>{
    const clickedSwatch = e.currentTarget;
    const group = clickedSwatch.closest('.group').dataset.group;

    // 이미 같은 스와치를 눌렀고 팔레트가 열려있으면 닫기
    if (!palette.hidden && currentSwatch === clickedSwatch) {
      palette.hidden = true;
      currentSwatch = null;
      currentGroup = null;
      return;
    }

    // 새로 열기
    currentSwatch = clickedSwatch;
    currentGroup  = group;

    const rect = currentSwatch.getBoundingClientRect();
    palette.style.left = `${rect.left + window.scrollX}px`;
    palette.style.top  = `${rect.bottom + 2 + window.scrollY}px`;
    palette.hidden = false;

    // 힌트 처음 누를 때 사라지게
    if (!hintDismissed && hintEl) {
      hintEl.classList.add('hidden');
      hintDismissed = true;
    }
  });
});

/* 팔레트에서 색 버튼 클릭 -> 실제 색 반영 */
palette.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-color]');
  if(!btn) return;

  const color = btn.dataset.color;
  if (currentGroup) {
    state[currentGroup].color = color;

    // 스와치 색 바꿔주기
    if (currentSwatch) {
      currentSwatch.style.backgroundColor = color;
    }

    // hands vs 나머지
    if (currentGroup === 'hands') {
      await applyHandsLayer();
    } else {
      await applyLayer(currentGroup);
    }

    // 색 바꾼 후에도 각도 유지
    updateHandRotation();

    pushHistory();
  }

  // 팔레트 닫기
  palette.hidden = true;
  currentSwatch = null; 
  currentGroup = null;

  // 힌트 강제 off (혹시 아직 남아 있으면)
  if (!hintDismissed && hintEl) {
    hintEl.classList.add('hidden');
    hintDismissed = true;
  }
});

/* 팔레트 외부 클릭 시 팔레트 닫기 */
document.addEventListener('click',(e)=>{
  const clickedSwatch = e.target.classList && e.target.classList.contains('color-swatch');
  if(!palette.hidden && !palette.contains(e.target) && !clickedSwatch){
    palette.hidden = true;
    currentSwatch = null; 
    currentGroup = null;
  }
});

/* ============ 뒤/앞 버튼 ============ */
const backBtn = document.getElementById('btn-back');
const fwdBtn  = document.getElementById('btn-forward');

backBtn && backBtn.addEventListener('click', ()=>{
  if(histIndex>0) restoreFromHistory(histIndex-1);
});

fwdBtn && fwdBtn.addEventListener('click', ()=>{
  if(histIndex<history.length-1) restoreFromHistory(histIndex+1);
});

/* ============ 스냅샷 합성 (complete용) ============ */
async function composeSnapshotDataURL() {
  const size = 1000;
  const canvas = document.createElement('canvas');
  canvas.width = size; 
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  // dial → numerals → marks → hands(hour/minute/second)
  const drawList = [
    imgEls.dial,
    imgEls.numerals,
    imgEls.marks,
    imgEls.hour,
    imgEls.minute,
    imgEls.second,
  ];

  for (const img of drawList) {
    if (!img || !img.src) continue;
    if (!img.complete) {
      await new Promise(r => img.addEventListener('load', r, { once:true }));
    }
    ctx.save();

    // 손 시계침은 회전(transform) 적용된 상태라 그냥 drawImage 하면 "돌기 전 모습"이 찍힘.
    // popup/아카이브는 'complete!' 순간의 각도 그대로 정지된 상태로 보이면 좋으니까,
    // 지금 transform(rotate) 값으로 캔버스도 돌려서 그려주자.

    // transform에서 rotate(XXXdeg)만 뽑아서 적용
    const match = img.style.transform.match(/rotate\(([-0-9.]+)deg\)/);
    if (match) {
      const deg = parseFloat(match[1]);
      const rad = deg * Math.PI/180;

      // drawImage는 좌상단 기준이니까,
      // 우리는 1000x1000 전체에 90%짜리 이미지를 5% 오프셋으로 두고 있음.
      // (applyHandsLayer에서 width/height=90%, left=5%, top=5%)
      // 이걸 그대로 재현:
      const boxX = 0.05 * size;      // 5%
      const boxY = 0.05 * size;
      const boxW = 0.90 * size;
      const boxH = 0.90 * size;

      // 회전은 그 박스의 중앙 기준
      const cx = boxX + boxW/2;
      const cy = boxY + boxH/2;

      ctx.translate(cx, cy);
      ctx.rotate(rad);
      ctx.translate(-cx, -cy);

      ctx.drawImage(img, boxX, boxY, boxW, boxH);
    } else {
      // 회전 없으면 그냥 전체에 맞춰서 (dial 등)
      ctx.drawImage(img, 0, 0, size, size);
    }

    ctx.restore();
  }

  return canvas.toDataURL('image/png');
}

/* ============ 팝업 관련 (complete!) ============ */
const popup         = document.getElementById('popup');
const minutesNowEl  = document.getElementById('minutesNow');
const createNewBtn  = document.getElementById('btn-create-new');
const logo          = document.getElementById('logo');
const closeBtn      = document.querySelector('#popup .close');
let pendingSnapshot = null;

function pad(n){ return String(n).padStart(2,'0'); }
function nowHHMMSS(){
  const d = new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* complete! 버튼 -> 팝업 띄우기 */
document.getElementById('btn-complete').addEventListener('click', async ()=>{
  // 현재 프리뷰(=현재 각도 그대로) 스냅샷 저장
  pendingSnapshot = await composeSnapshotDataURL();

  // 팝업 왼쪽 박스 중앙에 시계 이미지 깔기
  const snapshotEl = document.getElementById('popupSnapshot');
  if (snapshotEl && pendingSnapshot) {
    snapshotEl.src = pendingSnapshot;
  }

  // 시간 찍기
  if (minutesNowEl) minutesNowEl.textContent = nowHHMMSS();

  // 팝업 열기
  if (popup) popup.classList.add('show');
});

/* 팝업의 create new! -> 아카이브 prepend + 초기화 + 팝업 닫기 */
createNewBtn && createNewBtn.addEventListener('click', ()=>{
  if (pendingSnapshot) {
    const thumb = new Image();
    thumb.src = pendingSnapshot;
    thumb.style.width = '80%';
    thumb.style.display = 'block';
    thumb.style.margin = '16px auto';

    if (archiveList.firstChild) {
      archiveList.insertBefore(thumb, archiveList.firstChild);
    } else {
      archiveList.appendChild(thumb);
    }
  }

  // 프리뷰 초기화 (선택 전부 해제)
  state.dial.shape      = null;
  state.numerals.shape  = null;
  state.marks.shape     = null;
  state.hands.shape     = null;

  imgEls.dial.removeAttribute('src');
  imgEls.numerals.removeAttribute('src');
  imgEls.marks.removeAttribute('src');
  imgEls.hour.removeAttribute('src');
  imgEls.minute.removeAttribute('src');
  imgEls.second.removeAttribute('src');

  document.querySelectorAll('.group .opt').forEach(o=>o.classList.remove('active'));

  pushHistory();

  pendingSnapshot = null;
  popup && popup.classList.remove('show');
});

/* 로고 클릭해도 팝업 닫히게 */
logo && logo.addEventListener('click', () => {
  popup && popup.classList.remove('show');
});

/* 팝업 닫기(X) / 바깥 클릭 */
closeBtn && closeBtn.addEventListener('click', ()=> popup && popup.classList.remove('show'));
popup && popup.addEventListener('click', (e)=>{
  if (e.target === popup) popup.classList.remove('show');
});

/* ============ 초기 세팅 ============ */
(function init(){
  // 각 그룹별 스와치에 초기 색상 반영
  groups.forEach(g=>{
    const sw = document.querySelector(`.group[data-group="${g}"] .color-swatch`);
    if(sw) sw.style.backgroundColor = state[g].color;
  });

  // 팔레트 버튼들 배경색 세팅
  document.querySelectorAll('#color-palette button[data-color]').forEach(btn=>{
    btn.style.backgroundColor = btn.dataset.color;
    btn.title = btn.dataset.color;
  });

  // 첫 상태 기록
  pushHistory();

  // 힌트 위치 numerals 스와치 기준으로 맞추기
  positionHintToNumerals();

  // 첫 회전 세팅
  updateHandRotation();
})();

/* 창 크기 바뀔 때마다 힌트 위치 갱신 */
window.addEventListener('resize', positionHintToNumerals);

/* 매초마다 바늘 회전 업데이트 */
setInterval(updateHandRotation, 1000);


</script>
