<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>mmm</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
                html, body {
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
        }

        button {
            all: unset;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .container {
            display: flex;
            margin: 0;
            font-size: 1.5rem;
        }

        /* -------- ÏôºÏ™Ω Î°úÍ≥† -------- */
        .box-logo {
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #BF1122;
            box-shadow: 0 0 0 2px #BF1122;
        }
        #logo {
            cursor: pointer;
        }

        /* -------- ÏòµÏÖò ÏòÅÏó≠ -------- */
        .box-custom-options {
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #E6E6E6;
            box-shadow: 0 0 0 2px #BF1122;
            z-index: 10;
        }

        .option-head {
            display: inline-flex;
            width: 100%;
            color: #FFFFFF;
            box-sizing: border-box;
        }

        /* ÏôºÏ™Ω Ï†úÎ™© */
        .title {
            flex: 0 0 60%;
            padding-left: 8px;
            padding-top: 2px;
            padding-bottom: 2px;
            background-color: #BF1122;
            box-shadow: 0 0 0 2px #BF1122;
            box-sizing: border-box;
        }

        /* Ïò§Î•∏Ï™Ω ÏÉâÏÉÅÏπ∏ */
        .color-swatch {
            flex: 0 0 40%;
            box-shadow: 0 0 0 2px #BF1122;
            cursor: pointer;
            box-sizing: border-box;
        }

        /* Ïª¨Îü¨ ÌåîÎ†àÌä∏ */
        #color-palette {
            position: absolute;
            z-index: 9999;
            padding: 0px;
            background: #fff;
            box-shadow: 0 0 0 2px #BF1122;
            display: grid;
            grid-template-columns: repeat(5, 60px);
            gap: 0px;
        }
        #color-palette[hidden] { display: none; }
        #color-palette button {
            width: 60px;
            height: 50px;
            border: none;
            cursor: pointer;
        }

        /* Í∞Å ÏòµÏÖò */
        .options {
            background-color: #E6E6E6;
            color: #BF1122;
            padding-left: 8px;
            padding-top: 6px;
            padding-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .opt {
            display: block;
            cursor: pointer;
            user-select: none;
        }
        .opt:hover { background: #dcdcdc; }
        .opt.active { font-weight: 600; }

        /* -------- ÎØ∏Î¶¨Î≥¥Í∏∞ -------- */
        .box-preview {
            position: relative;
            width: 50%;
            height: 100vh;
            background-color: #f9f9f9;
            box-shadow: 0 0 0 2px #BF1122;
        }

        .menu-back-forward {
            display: flex;
            width: 100%;
            color: #BF1122;
            border-bottom: 2px solid #BF1122;
            position: relative;
            z-index: 1000;
        }

        #btn-back,
        #btn-forward {
            flex: 1 1 0;
            box-sizing: border-box;
            background-color: #ffffff;
            padding-left: 8px;
            padding-top: 2px;
            padding-bottom: 2px;
            font-size: inherit;
            line-height: 1.2;
            cursor: pointer;
            border: none;
            color: #BF1122;
        }

        #btn-back:hover, #btn-forward:hover {
            background-color: #BF1122;
            color: #FFFFFF;
        }

        #btn-forward {
            border-left: 2px solid #BF1122;
        }
        #btn-forward:hover {
            color: #FFFFFF;
        }

        /* complete! Î≤ÑÌäº */
        .complete-bar {
            display: flex;
            width: 100%;
            position: absolute;
            bottom: 0;
            padding-top: 6px;
            padding-bottom: 16px;
            background-color: #ffffff;
            color: #BF1122;
            box-shadow: 0 0 0 2px #BF1122;
            justify-content: center;
            cursor: pointer;
        }
        .complete-bar:hover {
            background-color: #BF1122;
            color: #FFFFFF;
        }

        /* -------- Ïò§Î•∏Ï™Ω ÏïÑÏπ¥Ïù¥Î∏å -------- */
        .box_archive {
            position: relative;
            width: 20%;
            height: 100vh;
            background-color: #f9f9f9;
            box-shadow: 0 0 0 2px #BF1122;
            display: flex;
            flex-direction: column;
        }

        .archive-head {
            padding-left: 8px;
            padding-top: 2px;
            padding-bottom: 2px;
            background-color: #BF1122;
            color: #FFFFFF;
            box-shadow: 0 0 0 2px #BF1122;
            flex: 0 0 auto;
        }

        .archive-list {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 12px;
        }
        .archive-list img {
            width: 80%;
            display: block;
            margin: 16px auto;
        }

        /* -------- ÌåùÏóÖ -------- */
        .popup {
            position: fixed;
            top: 0;
            right: 0;
            width: 85%;
            height: 100vh;
            display: none;
            z-index: 99999;
            background: url("./svg/popup-bg.svg") no-repeat center;
            background-size: cover;
            align-items: center;
            justify-content: center;
            transform-origin: center;
            animation: popIn 420ms cubic-bezier(.2,1.3,.3,1) both;
        }
        .popup.show { display: flex; }

        .popup-complete-panel {
            position: relative;
            width: 60%;
            align-items: center;
            justify-content: center;
        }
        .complete-box {
            width: 98%;
            display: block;
            z-index: 1;
        }
        .popup-snapshot {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: auto;
            object-fit: contain;
            z-index: 2;
            pointer-events: none;
        }
        .popup-right-panel {
            width: 30%;
            height: 100vh;
            padding-left: 40px;
        }
        .sticker { margin-top: 100px; }

        .minutes-window {
            box-shadow: 0 0 0 2px #BF1122;
            background: #BF1122;
            color: #fff;
            margin-top: 90px;
            margin-left: 10px;
            margin-right: 40px;
        }
        .minutes-title {
            font-weight: 400;
            font-size: 1.5rem;
            padding-left: 12px;
            padding-top: 5px;
            padding-bottom: 1px;
            box-shadow: 0 0 0 2px #BF1122;
        }
        .minutes-value {
            background: #E6E6E6;
            color: #BF1122;
            margin-top: 8px;
            padding: 10px 14px;
            font-weight: 400;
            font-size: 5rem;
            letter-spacing: .04em;
            box-shadow: 0 0 0 2px #BF1122;
        }

        /* -------- Î≤ÑÌäº -------- */
        .btn-new {
            margin-top: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            width: 140px;
            height: 140px;
            border-radius: 999px;
            background: #E6E6E6;
            color: #BF1122;
            border: 2px solid #BF1122;
            font-weight: 400;
            text-align: center;
            line-height: 120%;
        }
        .btn-new:hover { background: #BF1122; color: #fff; }

        .close {
            position: absolute;
            top: 14px;
            right: 18px;
            font-size: 28px;
            cursor: pointer;
            color: hsl(354, 84%, 41%);
        }

        /* -------- Ïï†ÎãàÎ©îÏù¥ÏÖò -------- */
        @keyframes popIn {
            0% { transform: scale(.0); opacity: 0; }
            70% { transform: scale(1.06); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* -------- ÏãúÍ≥Ñ Î†àÏù¥Ïñ¥ -------- */
        .layer:not([src]) { display: none; }
        .hand-layer {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 90%;
            height: 90%;
            object-fit: contain;
            transform-origin: 50% 50%;
        }

        /* -------- ÏÉâÏÉÅ ÌûåÌä∏ -------- */
        .color-hint {
            position: fixed;
            z-index: 5000;
            pointer-events: none;
            top: 0;
            left: 0;
            animation: floaty 2s ease-in-out infinite;
            opacity: 1;
            transition: opacity 0.4s ease;
        }
        .color-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }
        @keyframes floaty {
            0% { transform: translateY(8px); }
            50% { transform: translateY(0px); }
            100% { transform: translateY(8px); }
        }
        .color-hint img {
            display: block;
            width: 220px;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }

    </style>
</head>

<body>
  
<div class="container">
    <header class="box-logo">
        <img id="logo" src="./svg/logo.svg" style="width: 80%; padding: 16px">
    </header>

    <aside class="box-custom-options">
        <nav class="group" data-group="dial">
            <div class="option-head">
                <div class="title">dials</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="house">house</span>
                <span class="opt" data-value="convex square">convex square</span>
            </div>
        </nav>
        <nav class="group" data-group="numerals">
            <div class="option-head">
                <div class="title">numerals</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="numbers">numbers</span>
                <span class="opt" data-value="two dots">two dots</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
                <span class="opt" data-value="small sectors">small sectors</span>
                <span class="opt" data-value="big sectors">big sectors</span>
                <span class="opt" data-value="small squares">small squares</span>
                <span class="opt" data-value="big squares">big squares</span>
            </div>
        </nav>
        <nav class="group" data-group="marks">
            <div class="option-head">
                <div class="title">marks</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="line">line</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
            </div>
        </nav>
        <nav class="group" data-group="hands">
            <div class="option-head">
                <div class="title">hands</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="straight">straight</span>
                <span class="opt" data-value="arrow">arrow</span>
            </div>
        </nav>
    </aside>

    <main class="box-preview">
        <div class="menu-back-forward">
            <button id="btn-back" title="Îí§Î°úÍ∞ÄÍ∏∞">‚Ü©Ô∏é back</button>
            <button id="btn-forward" title="ÏïûÏúºÎ°úÍ∞ÄÍ∏∞">‚Ü™Ô∏é forward</button>
        </div>  
        <div class="stage-wrap">
            <div class="stage" id="stage">
                <!-- ÏãúÍ≥Ñ Î†àÏù¥Ïñ¥ -->
                <img id="L-dial" class="layer" alt="dial layer" />
                <img id="L-numerals" class="layer" alt="numerals layer" />
                <img id="L-marks" class="layer" alt="marks layer" />

                <!-- handsÎ•º ÏÑ∏ Ïû•ÏúºÎ°ú Ï™ºÍ∞† Î≤ÑÏ†Ñ -->
                <img id="L-hour"   class="layer hand-layer" alt="hour hand layer" />
                <img id="L-minute" class="layer hand-layer" alt="minute hand layer" />
                <img id="L-second" class="layer hand-layer" alt="second hand layer" />
            </div>
        </div>
        <div class="complete-bar" id="btn-complete">
            <button class="complete-btn">complete!</button>
        </div>
    </main>

    <aside class="box_archive">
        <div class="archive-head" aria-hidden="true">&nbsp;archive preview</div>
        <div class="archive-list" id="archiveList"></div>
    </aside>

</div>

<div id="color-palette" hidden>
  <button data-color="#C41224"></button>
  <button data-color="#EF4B3E"></button>
  <button data-color="#7ED0FF"></button>
  <button data-color="#D8F2C9"></button>
  <button data-color="#E4B5F1"></button>
  <button data-color="#5A1E22"></button>
  <button data-color="#E2C7CF"></button>
  <button data-color="#F7F0A4"></button>
  <button data-color="#FFFFFF"></button>
  <button data-color="#EBEBEB"></button>
</div>

<div id="popup" class="popup">
    <div class="popup-complete-panel">
      <img src="./svg/complete _box.svg" class="complete-box">
      <img id="popupSnapshot" class="popup-snapshot" alt="">
    </div>

    <div class="popup-right-panel">
      <img src="./svg/sticker.svg" class="sticker">
      <div class="minutes-window">
        <div class="minutes-title">your minutes are‚Ä¶</div>
        <div id="minutesNow" class="minutes-value">00:00:00</div>
      </div>
      <button id="btn-create-new" class="btn-new">create<br>new!</button>
    </div>
</div>

<div id="color-hint" class="color-hint">
  <img src="./svg/color-hint.svg" alt="try changing the colors!">
</div>

<audio id="tick-sound" src="./audio/clock.mp3"></audio>

</body>
</html>

<script>
const audioEl = document.getElementById('tick-sound');

  // 1) ÌéòÏù¥ÏßÄ Î°úÎìúÎêòÎ©¥ Ìïú Î≤à Ïû¨ÏÉù ÏãúÎèÑ
  window.addEventListener('load', () => {
    if (!audioEl) return;
    // controls ÏïàÎ≥¥Ïù¥Í≤å
    audioEl.style.display = 'none';

    // ÏûêÎèôÏû¨ÏÉù ÏãúÎèÑ
    audioEl.play().catch(() => {
      // Ïó¨Í∏∞Î°ú Ïò§Î©¥ Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎßâÏùÄ Í≤É
      // Îã§Ïùå ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Îïå Îã§Ïãú ÏãúÎèÑÌïòÎèÑÎ°ù ÏÑ§Ï†ï
      const tryPlayOnce = () => {
        audioEl.play().catch(()=>{});  // Ìïú Î≤à Îçî ÏãúÎèÑ
        document.removeEventListener('click', tryPlayOnce);
      };
      document.addEventListener('click', tryPlayOnce, { once: true });
    });
  });

/* ============ ÏÉÅÌÉú/DOM ============ */
const groups = ['dial','numerals','marks','hands'];
const stageEl = document.getElementById('stage');
const archiveList = document.getElementById('archiveList');
const palette = document.getElementById('color-palette');

const imgEls = {
  dial:     document.getElementById('L-dial'),
  numerals: document.getElementById('L-numerals'),
  marks:    document.getElementById('L-marks'),

  hour:     document.getElementById('L-hour'),
  minute:   document.getElementById('L-minute'),
  second:   document.getElementById('L-second'),
};

const defaultColors = {
  dial: '#7ED0FF',
  numerals: '#F7F0A4',
  marks: '#D3F4C9',
  hands: '#5F272C'
};

let state = {
  dial:      { shape:null, color: defaultColors.dial },
  numerals:  { shape:null, color: defaultColors.numerals },
  marks:     { shape:null, color: defaultColors.marks },
  hands:     { shape:null, color: defaultColors.hands }
};

/* ÌûåÌä∏ ÌíçÏÑ† Í¥ÄÎ†® */
const hintEl = document.getElementById('color-hint');
let hintDismissed = false;

/* üí° inactivity ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® */
let inactivityTimer = null;
const INACTIVITY_MS = 5000; // 7Ï¥à

function showHint() {
  if (!hintEl) return;
  // ÏúÑÏπò Îã§Ïãú ÎßûÏ∂∞Ï£ºÍ≥†
  positionHintToNumerals();
  // Îã§Ïãú Î≥¥Ïù¥Í≤å (opacity 1Î°ú ÌéòÏù¥ÎìúÏù∏)
  hintEl.classList.remove('hidden');
  hintDismissed = false;
}

function hideHint() {
  if (!hintEl) return;
  hintEl.classList.add('hidden');
  hintDismissed = true;
}

function resetInactivityTimer() {
  // ÌÉÄÏù¥Î®∏ Ï¥àÍ∏∞ÌôîÌïòÍ≥† Îã§Ïãú 5Ï¥à ÏÖãÏóÖ
  if (inactivityTimer) {
    clearTimeout(inactivityTimer);
  }
  inactivityTimer = setTimeout(() => {
    // 5Ï¥à ÎèôÏïà ÏïÑÎ¨¥ interaction ÏóÜÏúºÎ©¥ ÌûåÌä∏ Îã§Ïãú Îì±Ïû•
    showHint();
  }, INACTIVITY_MS);
}

/* Ï†ÑÏó≠ ÌÅ¥Î¶≠ Í∞êÏßÄÌï¥ÏÑú ÌÉÄÏù¥Î®∏ Î¶¨ÏÖã */
document.addEventListener('click', () => {
  resetInactivityTimer();
});

/* ============ ÌååÏùºÎ™Ö Îß§Ìïë(ÏòàÏô∏ Î≥¥Ï†ï) ============ */
const OVERRIDE = {
  numerals: {
    'numbers': 'numbers',
    'big squares': 'big squares'
  }
};

function filePath(group, value){
  const mapped = (OVERRIDE[group] && OVERRIDE[group][value]) ? OVERRIDE[group][value] : value;
  return `./svg/${group}_${mapped}.svg`;
}

/* ============ ÌûàÏä§ÌÜ†Î¶¨(Îí§/Ïïû) ============ */
const history = [];
let histIndex = -1;

function pushHistory(){
  history.splice(histIndex+1);
  history.push(JSON.parse(JSON.stringify(state)));
  histIndex = history.length - 1;
  updateNavButtons();
}
function restoreFromHistory(i){
  if(i<0 || i>=history.length) return;
  state = JSON.parse(JSON.stringify(history[i]));
  histIndex = i;
  applyStateToUI();
  updateNavButtons();
}
function updateNavButtons(){
  const b = document.getElementById('btn-back');
  const f = document.getElementById('btn-forward');
  if (b) b.style.opacity = (histIndex>0)?1:0.4;
  if (f) f.style.opacity = (histIndex<history.length-1)?1:0.4;
}

/* ============ SVG ÏÉâ Ï†ÅÏö© ============ */
async function colorizeSVGToURL(url, color){
  try{
    const res = await fetch(url);
    const text = await res.text();
    const styled = text.replace(
      /<svg([^>]*)>/i,
      (m,attrs)=>`<svg${attrs}><style>*{fill:${color};stroke:${color};}</style>`
    );
    const blob = new Blob([styled], {type:'image/svg+xml'});
    return URL.createObjectURL(blob);
  }catch(e){
    console.warn('fetch/colorize Ïã§Ìå® ‚Üí ÏõêÎ≥∏ Í≤ΩÎ°ú ÏÇ¨Ïö©:', url, e);
    return url;
  }
}

/* ============ dial / numerals / marks Î∞òÏòÅ ============ */
async function applyLayer(group){
  const {shape, color} = state[group];
  const img = imgEls[group];
  if(!img) return;
  if(!shape){ 
    img.removeAttribute('src'); 
    return; 
  }

  const src = filePath(group, shape);
  const coloredURL = await colorizeSVGToURL(src, color);
  img.src = coloredURL;

  let size = 90;
  if (group === 'numerals' && state.dial.shape === 'house') {
    size = 90 * 0.9; // 81
  }

  const offset = (100 - size) / 2;

  img.style.width = `${size}%`;
  img.style.height = `${size}%`;
  img.style.objectFit = 'contain';
  img.style.position = 'absolute';
  img.style.left = `${offset}%`;
  img.style.top = `${offset}%`;
}

/* ============ hands ÏÑ∏ Ïû• Î∞òÏòÅ ============ */
async function applyHandsLayer() {
  const { shape, color } = state.hands;

  if (!shape) {
    imgEls.hour.removeAttribute('src');
    imgEls.minute.removeAttribute('src');
    imgEls.second.removeAttribute('src');
    return;
  }

  const hourPath   = `./svg/hands_${shape}_hour.svg`;
  const minutePath = `./svg/hands_${shape}_minute.svg`;
  const secondPath = `./svg/hands_second.svg`;

  const hourURL   = await colorizeSVGToURL(hourPath,   color);
  const minuteURL = await colorizeSVGToURL(minutePath, color);
  const secondURL = await colorizeSVGToURL(secondPath, color);

  imgEls.hour.src   = hourURL;
  imgEls.minute.src = minuteURL;
  imgEls.second.src = secondURL;

  [imgEls.hour, imgEls.minute, imgEls.second].forEach(img => {
    img.style.width      = `90%`;
    img.style.height     = `90%`;
    img.style.objectFit  = 'contain';
    img.style.position   = 'absolute';
    img.style.left       = `5%`;
    img.style.top        = `5%`;
  });
}

/* ============ ÏãúÍ≥Ñ Î∞îÎäò ÌöåÏ†Ñ ============ */
function updateHandRotation() {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const s = now.getSeconds();

  const hourDeg   = ((h % 12) + m/60 + s/3600) * 30;
  const minuteDeg = (m + s/60) * 6;
  const secondDeg = s * 6;

  if (imgEls.hour) {
    imgEls.hour.style.transform   = `rotate(${hourDeg}deg)`;
  }
  if (imgEls.minute) {
    imgEls.minute.style.transform = `rotate(${minuteDeg}deg)`;
  }
  if (imgEls.second) {
    imgEls.second.style.transform = `rotate(${secondDeg}deg)`;
  }
}

/* ============ Ï†ÑÏ≤¥ state ‚Üí ÌôîÎ©¥ Î∞òÏòÅ ============ */
function applyStateToUI(){
  document.querySelectorAll('.group').forEach(g=>{
    const group = g.dataset.group;
    const sel = state[group].shape;
    g.querySelectorAll('.opt').forEach(o=>{
      o.classList.toggle('active', o.dataset.value === sel);
    });
    const sw = g.querySelector('.color-swatch');
    if(sw) sw.style.backgroundColor = state[group].color;
  });

  ['dial','numerals','marks'].forEach(applyLayer);

  applyHandsLayer();
  updateHandRotation();
}

/* ============ ÏòµÏÖò(ÎèÑÌòï) ÌÅ¥Î¶≠ ============ */
document.querySelectorAll('.group .opt').forEach(opt=>{
  opt.addEventListener('click', async (e)=>{
    state[e.currentTarget.closest('.group').dataset.group].shape = e.currentTarget.dataset.value;

    const wrap = e.currentTarget.parentElement;
    wrap.querySelectorAll('.opt').forEach(el=>el.classList.remove('active'));
    e.currentTarget.classList.add('active');

    if (e.currentTarget.closest('.group').dataset.group === 'hands') {
      await applyHandsLayer();
    } else {
      await applyLayer(e.currentTarget.closest('.group').dataset.group);
    }

    updateHandRotation();
    pushHistory();
  });
});

/* ============ ÌûåÌä∏ ÏúÑÏπò numerals Ïö∞Ï∏°Ïóê Î∂ôÏù¥Í∏∞ ============ */
function positionHintToNumerals() {
  if (!hintEl) return;

  const numeralsSwatch = document.querySelector('.group[data-group="numerals"] .color-swatch');
  if (!numeralsSwatch) return;

  const rect = numeralsSwatch.getBoundingClientRect();
  const offsetX = 8;
  const offsetY = -10;

  hintEl.style.left = (rect.right + offsetX) + 'px';
  hintEl.style.top  = (rect.top   + offsetY) + 'px';
}

/* ============ ÌåîÎ†àÌä∏(Ïª¨Îü¨ Î≥ÄÍ≤Ω) ============ */
let currentSwatch = null;
let currentGroup = null;

document.querySelectorAll('.group .color-swatch').forEach(swatch=>{
  swatch.addEventListener('click',(e)=>{
    const clickedSwatch = e.currentTarget;
    const group = clickedSwatch.closest('.group').dataset.group;

    // Ïù¥ÎØ∏ Í∞ôÏùÄ Ïä§ÏôÄÏπòÎ•º ÎàåÎ†ÄÍ≥† ÌåîÎ†àÌä∏Í∞Ä Ïó¥Î†§ÏûàÏúºÎ©¥ ‚Üí Îã´Í∏∞
    if (!palette.hidden && currentSwatch === clickedSwatch) {
      palette.hidden = true;
      currentSwatch = null;
      currentGroup = null;
      // ÌûåÌä∏Îäî Ïó¨Í∏∞ÏÑú Îî∞Î°ú Ïïà ÎßåÏßê
      return;
    }

    currentSwatch = clickedSwatch;
    currentGroup  = group;

    const rect = currentSwatch.getBoundingClientRect();
    palette.style.left = `${rect.left + window.scrollX}px`;
    palette.style.top  = `${rect.bottom + 2 + window.scrollY}px`;
    palette.hidden = false;

    // ÌûåÌä∏Îäî ÌÅ¥Î¶≠ Ïãú ÏÇ¨ÎùºÏßÄÍ≥† (=hideHint),
    // Í∑∏Î¶¨Í≥† inactivity ÌÉÄÏù¥Î®∏ Ïû¨ÏãúÏûë
    hideHint();
    resetInactivityTimer();
  });
});

/* ÌåîÎ†àÌä∏ÏóêÏÑú ÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ -> Ïã§Ï†ú ÏÉâ Î∞òÏòÅ */
palette.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-color]');
  if(!btn) return;

  const color = btn.dataset.color;
  if (currentGroup) {
    state[currentGroup].color = color;

    if (currentSwatch) {
      currentSwatch.style.backgroundColor = color;
    }

    if (currentGroup === 'hands') {
      await applyHandsLayer();
    } else {
      await applyLayer(currentGroup);
    }

    updateHandRotation();
    pushHistory();
  }

  palette.hidden = true;
  currentSwatch = null; 
  currentGroup = null;

  // ÏÉâ Ï∞çÍ≥† ÎÇòÏÑúÎèÑ Îã§Ïãú 5Ï¥à Í∏∞Îã§Î†∏Îã§Í∞Ä ÌûåÌä∏ Îú∞ Ïàò ÏûàÍ≤å
  resetInactivityTimer();
});

/* ÌåîÎ†àÌä∏ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÌåîÎ†àÌä∏ Îã´Í∏∞ */
document.addEventListener('click',(e)=>{
  const clickedSwatch = e.target.classList && e.target.classList.contains('color-swatch');
  if(!palette.hidden && !palette.contains(e.target) && !clickedSwatch){
    palette.hidden = true;
    currentSwatch = null; 
    currentGroup = null;
  }
});

/* ============ Îí§/Ïïû Î≤ÑÌäº ============ */
const backBtn = document.getElementById('btn-back');
const fwdBtn  = document.getElementById('btn-forward');

backBtn && backBtn.addEventListener('click', ()=>{
  if(histIndex>0) restoreFromHistory(histIndex-1);
});

fwdBtn && fwdBtn.addEventListener('click', ()=>{
  if(histIndex<history.length-1) restoreFromHistory(histIndex+1);
});

/* ============ Ïä§ÎÉÖÏÉ∑ Ìï©ÏÑ± (completeÏö©) ============ */
async function composeSnapshotDataURL() {
  const size = 1000;
  const canvas = document.createElement('canvas');
  canvas.width = size; 
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  const drawList = [
    imgEls.dial,
    imgEls.numerals,
    imgEls.marks,
    imgEls.hour,
    imgEls.minute,
    imgEls.second,
  ];

  for (const img of drawList) {
    if (!img || !img.src) continue;
    if (!img.complete) {
      await new Promise(r => img.addEventListener('load', r, { once:true }));
    }
    ctx.save();

    const match = img.style.transform && img.style.transform.match(/rotate\(([-0-9.]+)deg\)/);
    if (match) {
      const deg = parseFloat(match[1]);
      const rad = deg * Math.PI/180;

      const boxX = 0.05 * size;
      const boxY = 0.05 * size;
      const boxW = 0.90 * size;
      const boxH = 0.90 * size;

      const cx = boxX + boxW/2;
      const cy = boxY + boxH/2;

      ctx.translate(cx, cy);
      ctx.rotate(rad);
      ctx.translate(-cx, -cy);

      ctx.drawImage(img, boxX, boxY, boxW, boxH);
    } else {
      ctx.drawImage(img, 0, 0, size, size);
    }

    ctx.restore();
  }

  return canvas.toDataURL('image/png');
}

/* ============ ÌåùÏóÖ Í¥ÄÎ†® (complete!) ============ */
const popup         = document.getElementById('popup');
const minutesNowEl  = document.getElementById('minutesNow');
const createNewBtn  = document.getElementById('btn-create-new');
const logo          = document.getElementById('logo');
const closeBtn      = document.querySelector('#popup .close');
let pendingSnapshot = null;

function pad(n){ return String(n).padStart(2,'0'); }
function nowHHMMSS(){
  const d = new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* complete! Î≤ÑÌäº -> ÌåùÏóÖ ÎùÑÏö∞Í∏∞ */
document.getElementById('btn-complete').addEventListener('click', async ()=>{
  pendingSnapshot = await composeSnapshotDataURL();

  const snapshotEl = document.getElementById('popupSnapshot');
  if (snapshotEl && pendingSnapshot) {
    snapshotEl.src = pendingSnapshot;
  }

  if (minutesNowEl) minutesNowEl.textContent = nowHHMMSS();

  if (popup) popup.classList.add('show');
});

/* ÌåùÏóÖÏùò create new! -> ÏïÑÏπ¥Ïù¥Î∏å prepend + Ï¥àÍ∏∞Ìôî + ÌåùÏóÖ Îã´Í∏∞ */
createNewBtn && createNewBtn.addEventListener('click', ()=>{
  if (pendingSnapshot) {
    const thumb = new Image();
    thumb.src = pendingSnapshot;
    thumb.style.width = '80%';
    thumb.style.display = 'block';
    thumb.style.margin = '16px auto';

    if (archiveList.firstChild) {
      archiveList.insertBefore(thumb, archiveList.firstChild);
    } else {
      archiveList.appendChild(thumb);
    }
  }

  state.dial.shape      = null;
  state.numerals.shape  = null;
  state.marks.shape     = null;
  state.hands.shape     = null;

  imgEls.dial.removeAttribute('src');
  imgEls.numerals.removeAttribute('src');
  imgEls.marks.removeAttribute('src');
  imgEls.hour.removeAttribute('src');
  imgEls.minute.removeAttribute('src');
  imgEls.second.removeAttribute('src');

  document.querySelectorAll('.group .opt').forEach(o=>o.classList.remove('active'));

  pushHistory();

  pendingSnapshot = null;
  popup && popup.classList.remove('show');
});

/* Î°úÍ≥† ÌÅ¥Î¶≠Ìï¥ÎèÑ ÌåùÏóÖ Îã´ÌûàÍ≤å */
logo && logo.addEventListener('click', () => {
  popup && popup.classList.remove('show');
});

/* ÌåùÏóÖ Îã´Í∏∞(X) / Î∞îÍπ• ÌÅ¥Î¶≠ */
closeBtn && closeBtn.addEventListener('click', ()=> popup && popup.classList.remove('show'));
popup && popup.addEventListener('click', (e)=>{
  if (e.target === popup) popup.classList.remove('show');
});

/* ============ Ï¥àÍ∏∞ ÏÑ∏ÌåÖ ============ */
(function init(){
  groups.forEach(g=>{
    const sw = document.querySelector(`.group[data-group="${g}"] .color-swatch`);
    if(sw) sw.style.backgroundColor = state[g].color;
  });

  document.querySelectorAll('#color-palette button[data-color]').forEach(btn=>{
    btn.style.backgroundColor = btn.dataset.color;
    btn.title = btn.dataset.color;
  });

  pushHistory();

  positionHintToNumerals();

  updateHandRotation();

  resetInactivityTimer();
})();

/* Ï∞Ω ÌÅ¨Í∏∞ Î∞îÎÄî ÎïåÎßàÎã§ ÌûåÌä∏ ÏúÑÏπò Í∞±Ïã† */
window.addEventListener('resize', positionHintToNumerals);

/* Îß§Ï¥àÎßàÎã§ Î∞îÎäò ÌöåÏ†Ñ ÏóÖÎç∞Ïù¥Ìä∏ */
setInterval(updateHandRotation, 1000);

</script>
