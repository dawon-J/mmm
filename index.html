<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>mmm</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
          font-family: 'Inter', sans-serif;
        }

        button {all: unset; cursor: pointer; transition: all 0.2s ease;}
        .container{
            display: flex;
            margin: 0;
            font-size: 1.5rem;
        }
        .box-logo{
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #BF1122;
            outline: 2px solid #BF1122;
        }
        #logo {
            cursor: pointer;
        }
        
        .box-custom-options{
            position: relative;
            width: 15%;
            height: 100vh;
            background-color: #E6E6E6;
            outline: 2px solid #BF1122;
        }
        .option-head{
            display:inline-flex;
            width:100%;
            color:#FFFFFF;
        }
        .title{
            flex: 0 0 60%;
            padding-left: 8px; padding-top: 2px; padding-bottom: 2px;
            background-color: #BF1122;
            outline: 2px solid #BF1122;
        }
        .color-swatch{
            flex: 0 0 40%;
            outline: 2px solid #BF1122;
            cursor:pointer;
        }
        #color-palette{
            position:absolute; z-index:9999; padding:0px; background:#fff; outline:2px solid #BF1122;
            display:grid; grid-template-columns:repeat(5, 60px); gap:0px;
        }
        #color-palette[hidden]{ display:none; }
        #color-palette button{
            width:60px; height:50px; border:none; cursor:pointer;
        }
        
        .options{
            background-color: #E6E6E6; color: #BF1122;
            padding-left: 8px; padding-top: 6px; padding-bottom: 30px;
            display:flex; flex-direction:column;
            gap: 2px
        }
        .opt{display:block; cursor:pointer; user-select:none}
        .opt:hover{background:#dcdcdc}
        .opt.active{font-weight:600;}

        .box-preview{
            position: relative;
            width: 50%;
            height: 100vh;
            background-color: #f9f9f9;
            outline: 2px solid #BF1122;
        }

        .menu-back-forward{
            display:inline-flex;
            width:100%;
            color: #BF1122;
        }
        #btn-back, #btn-forward{
            padding-left: 8px; padding-top: 2px; padding-bottom: 2px;
            flex: 0 0 50%;
            background-color: #ffffff;
            outline: 2px solid #BF1122;
        }
        #btn-back:hover{background-color: #BF1122; color: #FFFFFF;}
        #btn-forward:hover{background-color: #BF1122; color: #FFFFFF;}
        
        .complete-bar{
            display: flex;
            width: 100%;
            position: absolute; bottom: 0; 
            padding-top: 6px; padding-bottom: 16px;
            background-color: #ffffff; color:#BF1122;
            outline: 2px solid #BF1122;
            justify-content: center;
            cursor: pointer;
        }
        .complete-bar:hover{background-color: #BF1122; color: #FFFFFF;}

        .box_archive{
            position: relative;
            width:20%;
            height: 100vh;
            background-color: #f9f9f9;
            outline: 2px solid #BF1122;
        }
        .archive-head{
            padding-left: 8px; padding-top: 2px; padding-bottom: 2px;
            background-color: #BF1122; color:#FFFFFF;
            outline: 2px solid #BF1122;
        }


        .popup {
            position: fixed;
            top: 0;
            right: 0;             /* 좌측 로고 영역만 남기고 */
            width: 85%;
            height: 100vh;
            display: none;         /* 기본 숨김 */
            z-index: 99999;
            background: url("./svg/popup-bg.svg") no-repeat center;
            background-size: 1620px auto; /* px 단위로 고정 크기 유지 */   
            align-items: center;
            justify-content: center;
            transform-origin: center;
            animation: popIn 420ms cubic-bezier(.2,1.3,.3,1) both;
        }

        .popup.show { display: flex; }

        .popup-complete-panel{
          position: relative;
          width: 60%;
          align-items: center;
          justify-content: center;
        }
        .complete-box{
          width: 98%;
          display: block;
          z-index: 1;
        }
        
        .popup-snapshot {
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 90%;
          height: auto;
          object-fit: contain;
          z-index: 2;
          pointer-events: none;
        }

        .popup-right-panel{
          width: 30%;
          height:100vh;
          padding-left: 40px;
        }

        .sticker{
          margin-top: 100px;
        }

        .minutes-window{
          outline: 2px solid #BF1122;
          background:#BF1122; 
          color:#fff;
          margin-top: 90px;
          margin-left: 10px;
          margin-right: 40px;
        }
        .minutes-title{ 
          font-weight:400; 
          font-size: 1.5rem;
          padding-left: 12px; padding-top: 5px; padding-bottom: 1px;
          outline: 2px solid #BF1122;
        }
        .minutes-value{
          background:#E6E6E6; color:#BF1122;
          margin-top:8px; 
          padding:10px 14px; font-weight:400; 
          font-size: 5rem; letter-spacing: .04em;
          outline: 2px solid #BF1122;
        }

        /* create new 버튼 */
        .btn-new{
            margin-top: 100px;
            display:flex; align-items:center; justify-content:center;
            font-size: 1.5rem;
            width:140px; height:140px; border-radius:999px;
            background:#E6E6E6; color:#BF1122; 
            border:2px solid #BF1122; font-weight:400;
            text-align: center; line-height: 120%;
        }
        .btn-new:hover{ background:#BF1122; color: #ffffff;}

        /* 닫기(X) */
        .close {
            position:absolute; top:14px; right:18px; 
            font-size:28px; cursor:pointer; color:hsl(354, 84%, 41%);
        }

        @keyframes popIn {
            0%   { transform: scale(.0);   opacity: 0; }
            70%  { transform: scale(1.06); opacity: 1; }
            100% { transform: scale(1);    opacity: 1; }
        }
                      

        .layer:not([src]) {
          display: none;
        }

        /* ▼ 추가: 회전 가능한 시침/분침/초침용 공통 스타일  */
        .hand-layer {
          position: absolute;
          left: 50%;
          top: 50%;
          width: 90%;
          height: 90%;
          object-fit: contain;
          transform-origin: 50% 50%;
        }

    </style>
</head>

<body>
  
<div class="container">
    <header class="box-logo">
        <img id="logo" src="./svg/logo.svg" style="width: 80%; padding: 16px">
    </header>

    <aside class="box-custom-options">
        <nav class="group" data-group="dial">
            <div class="option-head">
                <div class="title">dials</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="house">house</span>
                <span class="opt" data-value="convex square">convex square</span>
            </div>
        </nav>
        <nav class="group" data-group="numerals">
            <div class="option-head">
                <div class="title">numerals</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="numbers">numbers</span>
                <span class="opt" data-value="two dots">two dots</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
                <span class="opt" data-value="small sectors">small sectors</span>
                <span class="opt" data-value="big sectors">big sectors</span>
                <span class="opt" data-value="small squares">small squares</span>
                <span class="opt" data-value="big squares">big squares</span>
            </div>
        </nav>
        <nav class="group" data-group="marks">
            <div class="option-head">
                <div class="title">marks</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="line">line</span>
                <span class="opt" data-value="small dots">small dots</span>
                <span class="opt" data-value="big dots">big dots</span>
            </div>
        </nav>
        <nav class="group" data-group="hands">
            <div class="option-head">
                <div class="title">hands</div>
                <div class="color-swatch"></div>
            </div>
            <div class="options">
                <span class="opt" data-value="circle">circle</span>
                <span class="opt" data-value="square">square</span>
                <span class="opt" data-value="straight">straight</span>
                <span class="opt" data-value="arrow">arrow</span>
            </div>
        </nav>
    </aside>

    <main class="box-preview">
        <div class="menu-back-forward">
            <button id="btn-back" title="뒤로가기">↩︎ back</button>
            <button id="btn-forward" title="앞으로가기">↪︎ forward</button>
        </div>  
        <div class="stage-wrap">
            <div class="stage" id="stage">
                <!-- 시계 레이어 -->
                <img id="L-dial" class="layer" alt="dial layer" />
                <img id="L-numerals" class="layer" alt="numerals layer" />
                <img id="L-marks" class="layer" alt="marks layer" />

                <!-- hands를 세 장으로 쪼갠 버전 -->
                <img id="L-hour"   class="layer hand-layer" alt="hour hand layer" />
                <img id="L-minute" class="layer hand-layer" alt="minute hand layer" />
                <img id="L-second" class="layer hand-layer" alt="second hand layer" />
            </div>
        </div>
        <div class="complete-bar" id="btn-complete">
            <button class="complete-btn">complete!</button>
        </div>
    </main>

    <aside class="box_archive">
        <div class="archive-head" aria-hidden="true">&nbsp;archive preview</div>
        <div class="archive-list" id="archiveList"></div>
    </aside>

</div>

<div id="color-palette" hidden>
  <button data-color="#C41224"></button>
  <button data-color="#EF4B3E"></button>
  <button data-color="#7ED0FF"></button>
  <button data-color="#D8F2C9"></button>
  <button data-color="#E4B5F1"></button>
  <button data-color="#5A1E22"></button>
  <button data-color="#E2C7CF"></button>
  <button data-color="#F7F0A4"></button>
  <button data-color="#FFFFFF"></button>
  <button data-color="#EBEBEB"></button>
</div>


<div id="popup" class="popup">
    <div class="popup-complete-panel">
      <img src="./svg/complete _box.svg" class="complete-box">
      <img id="popupSnapshot" class="popup-snapshot" alt="">
    </div>

    <div class="popup-right-panel">
      <img src="./svg/sticker.svg" class="sticker">
      <div class="minutes-window">
        <div class="minutes-title">your minutes are…</div>
        <div id="minutesNow" class="minutes-value">00:00:00</div>
      </div>
      <button id="btn-create-new" class="btn-new">create<br>new!</button>
    </div>
</div>


<script>
/* ============ 상태/DOM ============ */
const groups = ['dial','numerals','marks','hands'];

const stageEl     = document.getElementById('stage');
const archiveList = document.getElementById('archiveList');
const palette     = document.getElementById('color-palette');

const imgEls = {
  dial:      document.getElementById('L-dial'),
  numerals:  document.getElementById('L-numerals'),
  marks:     document.getElementById('L-marks')
  // hands는 아래에서 hour/minute/second 별도로 다룬다
};

const hourEl   = document.getElementById('L-hour');
const minuteEl = document.getElementById('L-minute');
const secondEl = document.getElementById('L-second');

const popup           = document.getElementById('popup');
const popupSnapshotEl = document.getElementById('popupSnapshot');
const minutesNowEl    = document.getElementById('minutesNow');
const createNewBtn    = document.getElementById('btn-create-new');
const logo            = document.getElementById('logo');
const closeBtn        = document.querySelector('#popup .close'); // (지금은 없지만 대비)

const defaultColors = {
  dial: '#7ED0FF',
  numerals: '#F7F0A4',
  marks: '#D3F4C9',
  hands: '#5F272C'
};

let state = {
  dial:      { shape:null, color: defaultColors.dial },
  numerals:  { shape:null, color: defaultColors.numerals },
  marks:     { shape:null, color: defaultColors.marks },
  hands:     { shape:null, color: defaultColors.hands } // shape: circle/square/straight/arrow
};

/* ============ 파일명 매핑(예외 보정) ============ */
/* 규칙: ./svg/{group}_{value}.svg */
const OVERRIDE = {
  numerals: {
    'numbers': 'numbers',
    'big squares': 'big squares'
  }
};

function filePath(group, value){
  const mapped = (OVERRIDE[group] && OVERRIDE[group][value]) 
    ? OVERRIDE[group][value] 
    : value;
  return `./svg/${group}_${mapped}.svg`;
}

/* ============ 히스토리(뒤/앞) ============ */
const history = [];
let histIndex = -1;

function pushHistory(){
  history.splice(histIndex+1);
  history.push(JSON.parse(JSON.stringify(state)));
  histIndex = history.length - 1;
  updateNavButtons();
}
function restoreFromHistory(i){
  if(i<0 || i>=history.length) return;
  state = JSON.parse(JSON.stringify(history[i]));
  histIndex = i;
  applyStateToUI();
  updateNavButtons();
}
function updateNavButtons(){
  const b = document.getElementById('btn-back');
  const f = document.getElementById('btn-forward');
  if (b) b.style.opacity = (histIndex>0)?1:0.4;
  if (f) f.style.opacity = (histIndex<history.length-1)?1:0.4;
}

/* ============ SVG 색 적용 ============ */
async function colorizeSVGToURL(url, color){
  try{
    const res = await fetch(url);
    const text = await res.text();
    const styled = text.replace(
      /<svg([^>]*)>/i,
      (m,attrs)=>`<svg${attrs}><style>*{fill:${color};stroke:${color};}</style>`
    );
    const blob = new Blob([styled], {type:'image/svg+xml'});
    return URL.createObjectURL(blob);
  }catch(e){
    console.warn('fetch/colorize 실패 → 원본 경로 사용:', url, e);
    return url;
  }
}

/* ============ 레이어 반영 ============ */
/* dial / numerals / marks */
async function applyBasicLayer(group){
  const {shape, color} = state[group];
  const img = imgEls[group];
  if(!shape){ 
    img.removeAttribute('src'); 
    return; 
  }

  const src = filePath(group, shape);
  const coloredURL = await colorizeSVGToURL(src, color);
  img.src = coloredURL;

  // 기본 크기: 90% (가운데 배치)
  let size = 90;

  // dial이 'house'일 때 numerals만 한 번 더 축소(=81%)
  if (group === 'numerals' && state.dial.shape === 'house') {
    size = 90 * 0.9; // 81
  }

  const offset = (100 - size) / 2;

  img.style.width = `${size}%`;
  img.style.height = `${size}%`;
  img.style.objectFit = 'contain';
  img.style.position = 'absolute';
  img.style.left = `${offset}%`;
  img.style.top = `${offset}%`;
}

/* hands: 시침/분침/초침 세 장 */
async function applyHandsLayer(){
  const { shape, color } = state.hands;
  if(!shape){
    hourEl.removeAttribute('src');
    minuteEl.removeAttribute('src');
    secondEl.removeAttribute('src');
    return;
  }

  // 네가 준비한 파일명 규칙:
  // hands_<shape>_hour.svg
  // hands_<shape>_minute.svg
  // hands_second.svg (초침은 공통)
  const hourSrc   = `./svg/hands_${shape}_hour.svg`;
  const minuteSrc = `./svg/hands_${shape}_minute.svg`;
  const secondSrc = `./svg/hands_second.svg`;

  hourEl.src   = await colorizeSVGToURL(hourSrc, color);
  minuteEl.src = await colorizeSVGToURL(minuteSrc, color);
  secondEl.src = await colorizeSVGToURL(secondSrc, color);

  // 위치/사이즈: stage 기준 가운데
  [hourEl, minuteEl, secondEl].forEach(el => {
    el.style.position        = 'absolute';
    el.style.left            = '50%';
    el.style.top             = '50%';
    el.style.width           = '90%';
    el.style.height          = '90%';
    el.style.objectFit       = 'contain';
    el.style.transformOrigin = '50% 50%';
  });
}

/* group별로 분기 */
async function applyLayer(group){
  if (group === 'hands') {
    await applyHandsLayer();
  } else {
    await applyBasicLayer(group);
  }
}

/* 전체 state를 UI에 반영 */
function applyStateToUI(){
  // 옵션 active 표시 / 스와치 색 업데이트
  document.querySelectorAll('.group').forEach(g=>{
    const group = g.dataset.group;
    const sel = state[group].shape;
    g.querySelectorAll('.opt').forEach(o=>{
      o.classList.toggle('active', o.dataset.value === sel);
    });
    const sw = g.querySelector('.color-swatch');
    if(sw) sw.style.backgroundColor = state[group].color;
  });

  groups.forEach(applyLayer);
}

/* ============ 옵션 선택 ============ */
document.querySelectorAll('.group .opt').forEach(opt=>{
  opt.addEventListener('click', async (e)=>{
    const group = e.currentTarget.closest('.group').dataset.group;
    const value = e.currentTarget.dataset.value;
    state[group].shape = value;

    // active 표시
    const wrap = e.currentTarget.parentElement;
    wrap.querySelectorAll('.opt').forEach(el=>el.classList.remove('active'));
    e.currentTarget.classList.add('active');

    await applyLayer(group);
    pushHistory();
  });
});

/* ============ 팔레트(색 선택) ============ */
let currentSwatch = null;
let currentGroup = null;

document.querySelectorAll('.group .color-swatch').forEach(swatch=>{
  swatch.addEventListener('click',(e)=>{
    currentSwatch = e.currentTarget;
    currentGroup  = e.currentTarget.closest('.group').dataset.group;
    const rect = currentSwatch.getBoundingClientRect();
    palette.style.left = `${rect.left + window.scrollX}px`;
    palette.style.top  = `${rect.bottom + 2 + window.scrollY}px`;
    palette.hidden = false;
  });
});

palette.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-color]');
  if(!btn) return;
  const color = btn.dataset.color;
  if(currentGroup){
    state[currentGroup].color = color;
    if(currentSwatch) currentSwatch.style.backgroundColor = color;
    await applyLayer(currentGroup);
    pushHistory();
  }
  palette.hidden = true;
  currentSwatch = null; currentGroup = null;
});

document.addEventListener('click',(e)=>{
  if(!palette.hidden && !palette.contains(e.target) && !e.target.classList.contains('color-swatch')){
    palette.hidden = true;
    currentSwatch = null; currentGroup = null;
  }
});

/* ============ 뒤/앞 버튼 ============ */
const backBtn = document.getElementById('btn-back');
const fwdBtn  = document.getElementById('btn-forward');
backBtn && backBtn.addEventListener('click', ()=>{
  if(histIndex>0) restoreFromHistory(histIndex-1);
});
fwdBtn && fwdBtn.addEventListener('click', ()=>{
  if(histIndex<history.length-1) restoreFromHistory(histIndex+1);
});

/* ============ 실시간 시계 움직임 (프리뷰에서 바늘 회전) ============ */
function updateLiveHands() {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const s = now.getSeconds();

  // 각도 계산
  const hourDeg   = (h % 12) * 30 + m * 0.5;
  const minuteDeg = m * 6 + s * 0.1;
  const secondDeg = s * 6;

  if (hourEl) {
    hourEl.style.transform =
      `translate(-50%, -50%) rotate(${hourDeg}deg)`;
  }
  if (minuteEl) {
    minuteEl.style.transform =
      `translate(-50%, -50%) rotate(${minuteDeg}deg)`;
  }
  if (secondEl) {
    secondEl.style.transform =
      `translate(-50%, -50%) rotate(${secondDeg}deg)`;
  }
}
updateLiveHands();
setInterval(updateLiveHands, 1000);

/* freeze된 시각 기준 각도 계산 */
function getAnglesForDate(d) {
  const h = d.getHours();
  const m = d.getMinutes();
  const s = d.getSeconds();
  return {
    hourDeg:   (h % 12) * 30 + m * 0.5,
    minuteDeg: m * 6 + s * 0.1,
    secondDeg: s * 6
  };
}

/* ============ 스냅샷 합성 (팝업/아카이브용) ============ */
/*
    freezeTime(complete 누른 순간) 기준으로
    dial / numerals / marks / hands(hour/minute/second) 전부 회전 반영해서
    고해상도 캔버스에 그린다.
*/
async function composeSnapshotDataURL(freezeTime) {
  const size = 1000;
  const canvas = document.createElement('canvas');
  canvas.width = size; 
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingQuality = 'high';
  ctx.clearRect(0,0,size,size);

  const dialImg    = document.getElementById('L-dial');
  const numsImg    = document.getElementById('L-numerals');
  const marksImg   = document.getElementById('L-marks');
  const hourImg    = document.getElementById('L-hour');
  const minuteImg  = document.getElementById('L-minute');
  const secondImg  = document.getElementById('L-second');

  async function drawPlain(imgEl){
    if (!imgEl || !imgEl.src) return;
    if (!imgEl.complete) {
      await new Promise(r => imgEl.addEventListener('load', r, { once:true }));
    }
    ctx.drawImage(imgEl, 0, 0, size, size);
  }

  // 다이얼
  await drawPlain(dialImg);
  // 숫자
  await drawPlain(numsImg);
  // 마크
  await drawPlain(marksImg);

  // freeze된 각도
  const { hourDeg, minuteDeg, secondDeg } = getAnglesForDate(freezeTime);

  async function drawRotatedHand(imgEl, deg){
    if (!imgEl || !imgEl.src) return;
    if (!imgEl.complete){
      await new Promise(r=>imgEl.addEventListener('load', r, {once:true}));
    }
    ctx.save();
    ctx.translate(size/2, size/2);
    ctx.rotate(deg * Math.PI/180);
    // 바늘 SVG는 12시 방향 기준으로 위로 뻗어 있다고 가정
    ctx.drawImage(imgEl, -size/2, -size/2, size, size);
    ctx.restore();
  }

  await drawRotatedHand(hourImg,   hourDeg);
  await drawRotatedHand(minuteImg, minuteDeg);
  await drawRotatedHand(secondImg, secondDeg);

  return canvas.toDataURL('image/png');
}

/* ============ 팝업 ============ */
let pendingSnapshot = null;

logo && logo.addEventListener('click', () => {
  popup && popup.classList.remove('show');
});
closeBtn && closeBtn.addEventListener('click', ()=> popup && popup.classList.remove('show'));
popup && popup.addEventListener('click', (e)=>{
  if (e.target === popup) popup.classList.remove('show');
});

function pad(n){ return String(n).padStart(2,'0'); }
function nowHHMMSS(){
  const d = new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

/* complete → 팝업 열기 */
document.getElementById('btn-complete').addEventListener('click', async ()=>{
  const freezeTime = new Date(); // 지금 시간 고정

  pendingSnapshot = await composeSnapshotDataURL(freezeTime);

  if (popupSnapshotEl && pendingSnapshot) {
    popupSnapshotEl.src = pendingSnapshot;
  }

  if (minutesNowEl) minutesNowEl.textContent = nowHHMMSS();

  if (popup) popup.classList.add('show');
});

/* 팝업의 create new → 아카이브 추가 + 초기화 + 닫기 */
createNewBtn && createNewBtn.addEventListener('click', ()=>{
  if (pendingSnapshot) {
    const thumb = new Image();
    thumb.src = pendingSnapshot;
    thumb.style.width = '80%';
    thumb.style.display = 'block';
    thumb.style.margin = '16px auto';
    if (archiveList.firstChild) {
      archiveList.insertBefore(thumb, archiveList.firstChild);
    } else {
      archiveList.appendChild(thumb);
    }
  }

  // 프리뷰 리셋
  groups.forEach(g=>{
    state[g].shape = null;
    if(g === 'hands'){
      hourEl.removeAttribute('src');
      minuteEl.removeAttribute('src');
      secondEl.removeAttribute('src');
    } else {
      imgEls[g]?.removeAttribute('src');
    }
    const groupEl = document.querySelector(`.group[data-group="${g}"]`);
    groupEl && groupEl.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
  });
  pushHistory();

  pendingSnapshot = null;
  popup && popup.classList.remove('show');
});

/* ============ 초기화 ============ */
(function init(){
  groups.forEach(g=>{
    const sw = document.querySelector(`.group[data-group="${g}"] .color-swatch`);
    if(sw) sw.style.backgroundColor = state[g].color;
  });

  // 팔레트 색상칩 채우기
  document.querySelectorAll('#color-palette button[data-color]').forEach(btn=>{
    btn.style.backgroundColor = btn.dataset.color;
    btn.title = btn.dataset.color;
  });

  pushHistory();
})();
</script>
</body>
</html>
